---
title: "Final Report"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    theme: lumen
---

```{r, include=FALSE}
library(tidyverse)
library(tidytext)  
library(httr)
library(rvest)
library(lubridate)
library(plotly)
library(patchwork)
library(lmtest)
library(dplyr)
library(tidycensus)
require(data.table)
library(gridExtra)
library(ggplot2)
library(data.table)
library(tidycensus)
library(tidyverse)
library(ggridges)
library(patchwork)
library(viridis)
library(modelr)
library(mgcv)
library(readxl)
library(plotly)
library(kableExtra)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%")

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis")

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

## Motivation

In 2020, the world entered into a pandemic. Now--two years later--as we recover and try to move on with life, things are different. The pandemic brought with it a new lens that showed disparities based on socioeconomic status (SES), geographical location, etc. which always existed but were too often disregarded. Research has shown that people of color and those from lower SES are at higher risk of contracting COVID-19. Therefore, public health professionals should be cognizant of such gaps and should make an effort to minize such inequities (Khanijahani et al., 2021).

## Analysis and Relevance

Our project looks at the change in COVID-19 incidence and risk in New York state for each county, specifically how COVID-19 is is temporally auto-correlated in New York City, the most populous county. We also looked at whether county health factor ranking and socioeconomic (SE) determinants of health are associated with this change in trends by county. These analyses can be helpful to public health officials in the following ways:
  
First, understanding the spatio-temporal patterns of COVID-19 trends can help public health officials identify areas that are at higher risk for the spread of the virus. This information can be used to target interventions and resources to these areas to reduce the spreading of COVID-19 at an early stage.

Second, examining the relationship between county health ranking, especially county health factors, and SE determinants in relation to COVID-19 trend can help public health officials identify risk factors unique to those residing in majority-minority neighborhoods. Findings from these observations can be used to design community-based policies and interventions, working to minimize SE health inequities.

Overall, these discoveries can help public health officials better understand the spread of COVID-19 and take effective actions to reduce the risk of transmission in communities at higher risk while addressing preexisting health disparities.

## Data Processing and Cleaning

### Data Sources
Our data were downloaded from four different sources:

1. **New York State Demographics**: US Census Bureau's demographics data were imported using `tidycensus`.

2. **New York State, County Land Area** [(dataset)](https://www.health.ny.gov/statistics/vital_statistics/2010/table02.htm)
A .csv file was created based on the information provided in the website.  
Note: unable to be loaded using `read_html` as this is an xml document.

3. **New York State Health Ranking** [(dataset)](https://www.countyhealthrankings.org/explore-health-rankings/new-york/data-and-resources):
Four data sets (2019, 2020, 2021 and 2022 New York State Health Ranking Data) were downloaded as .xls/xlsx. These data sets are provided by the University of Wisconsin Population Health Institute, which performs extensive analyses to calculate each New York county's score for health factors (health behaviors, clinical care, SES factors, and physical environment) and health outcome (quality of life, and length of life). 

4. **New York State COVID-19** [(dataset)](https://data.ny.gov/browse?tags=covid-19):
Three data sets (COVID testing, COVID vaccination, COVID fatalities from 2020 to 11/2022) were downloaded as .csv.

### Data Cleaning
1. **New York State Demographics**  
We imported US Census Bureau's 2020 data because 2021 data are not available until 12/8/2022. As demographics data do not change significantly each year, 2020 data were used for analysis. We decided to include the following variables, as we would like to adjust for them in our models:
* total population in each county (tpop)
* median age in each county (medage)
* racial diversity index (race_div): calculated Simpson's Diversity Index in lines 65 to 69 (higher index indicates more racial diversity)

```{r census_data, results = FALSE, message = FALSE}
census_api_key("aa512886c5449a582d837da8d3a07af66a043fe5")

census_data <- load_variables(2020, "acs5", cache=T)
fwrite(census_data, "census_variables.csv")

vars <- c(tpop = 'P001001',
          medage = 'P013001',
          wpop = 'P003002',
          bpop = 'P003003',
          apop = 'P003005',
          hpop = 'P004003')

nys_df <- get_decennial(state = "ny", 
                       geography = "county",
                       variables = vars,
                       geometry = T,
                       output = "wide")

NY_df <- get_decennial(state = "ny", 
                       geography = "county",
                       variables = vars,
                       geometry = T,
                       output = "wide")

NY_df = NY_df %>%
  mutate(
    county = gsub(" County, New York","",NAME))

nys_df = nys_df %>%
  mutate(
    county = gsub(" County, New York","",NAME))

nys_df$race_div <- 1 - (((nys_df$wpop*(nys_df$wpop-1))+
                          (nys_df$bpop*(nys_df$bpop-1))+
                          (nys_df$hpop*(nys_df$hpop-1))+
                          (nys_df$apop*(nys_df$apop-1)))/
                         (nys_df$tpop*(nys_df$tpop-1)))

nys_df = nys_df %>% 
  select(tpop, medage, county, race_div)
```

2.  **New York State, County Land Area**
After loading the dataset, which only contains two variables--county and value (provides area of each county as square mile; this variable was renamed as "area")--the dataset was merged with nys_df to calculate population density for each county. The population density variable was created so we can adjust for it in our regression models.

```{r, results = FALSE}
area = read_excel('data/pop_density.xlsx') %>% 
  janitor::clean_names() %>% 
  rename(area = value)

nys_df = left_join(nys_df, area, by = 'county') %>% 
  mutate(pop_d = tpop/area)
```

3. **New York State Health Ranking**  
Same steps were taken for each year except 2019; for this year, the sub-variables from the "Ranked Measure Data" sheet were labeled differently. 

As the original excel files contain multiple sheets. We only imported the sheets that contain variables of interest.  
 <br>Each county's health ranking was imported from the sheet named "Outcomes & Factors SubRankings." From the sheet, only the following variables were selected for future analysis: each county's rank for health outcomes (quality of life, renamed to qol_r; length of life, renamed to longevity_r), health factors (health behaviors, renamed to health_beh_r; clinical_care, renamed to clinical_care_r; socioeconomic factors, renamed to ses_r; physical environment, renamed to env_r).
 <br>Additionally, further information on each county's socioeconomic factors and race/ethnicity were imported from the sheet named "Additional Measure Data." The following variables were selected: each county's segregation index (white vs. nonwhite), renamed to segregation_score; median household income, renamed household_income; % Hispanic, p_hispanic; % Black, renamed p_black); and % White; p_white. As we are interested in observing racial and socioeconomic disparities in COVID, we then created the following variables: % minority (Hispanic and Black), named p_minority; binary variable for low vs. moderate/high level of segregation. The cutoff value for level of segregation was set as 30. [(source)](https://www1.udel.edu/uapp800/Lecture%20Material/Index%20of%20Dissimilarity%20Example.htm)
 <br>Lastly, we imported data from the sheet labeled "Ranked Measure Data" to import health behaviors' sub-variables. We imported the variables county, percent of smokers, percent of adults with obesity, food environment index (0-10 with 10 as the best), percent of adults who are physically inactive, percent of adults with access to location with opportunities to exercise, percent of adults who report excessive drinking, percent of driving related deaths with alcohol involved, the number of chlamydia cases, and the teen birth rate per every 1000 females aged 15-19.

```{r, results = FALSE, message = FALSE} 
# 2019 HR Data

hr2019 = read_excel('data/ny_hr19.xls', 
                    sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2019 = read_excel('data/ny_hr19.xls', 
                      sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'segregation_index_2',
         'household_income',
         'percent_hispanic',
         'percent_african_american',
         'percent_non_hispanic_white') %>% 
  rename(median_income = household_income,
         segregation_score = segregation_index_2,
         p_hispanic = percent_hispanic,
         p_black = percent_african_american,
         p_white = percent_non_hispanic_white) %>%
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_black + p_hispanic)

sub_var19 =
  read_excel('data/ny_hr19.xls', sheet = 'Ranked Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>%
  select(county, percent_smokers, percent_obese, food_environment_index, percent_physically_inactive, percent_with_access, percent_excessive_drinking, percent_alcohol_impaired, number_chlamydia_cases, teen_birth_rate, percent_unemployed)
  

list_2019 =
  list(hr2019, demo2019, sub_var19)

total2019 = 
  list_2019 %>%
  reduce(full_join, by = "county") %>%
  mutate(year = 2019)

# 2020 HR Data
hr2020 = read_excel('data/ny_hr20.xlsx', 
                    sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2020 = read_excel('data/ny_hr20.xlsx', 
                      sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'median_household_income', 
         'segregation_index_2',
         'percent_black',
         'percent_hispanic',
         'percent_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         segregation_score = segregation_index_2,
         p_black = percent_black,
         p_hispanic = percent_hispanic,
         p_white = percent_non_hispanic_white) %>% 
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_black + p_hispanic)

sub_var20 =
  read_excel('data/ny_hr20.xlsx', sheet = 'Ranked Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>%
  select(county, percent_smokers, percent_adults_with_obesity, 
         food_environment_index, percent_physically_inactive, 
         percent_with_access_to_exercise_opportunities, 
         percent_excessive_drinking, 
         percent_driving_deaths_with_alcohol_involvement, 
         number_chlamydia_cases, teen_birth_rate, percent_unemployed) %>%
  rename(percent_obese = percent_adults_with_obesity,
         percent_with_access = percent_with_access_to_exercise_opportunities,
         percent_alcohol_impaired = 
           percent_driving_deaths_with_alcohol_involvement)
  

list_2020 =
  list(hr2020, demo2020, sub_var20)

total2020 = 
  list_2020 %>%
  reduce(full_join, by = "county") %>%
  mutate(year = 2020)

# 2021 HR Data
hr2021 = read_excel('data/ny_hr21.xlsx', 
                    sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2021 = read_excel('data/ny_hr21.xlsx', 
                      sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'median_household_income', 
         'segregation_index_2',
         'percent_black',
         'percent_hispanic',
         'percent_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         segregation_score = segregation_index_2,
         p_black = percent_black,
         p_hispanic = percent_hispanic,
         p_white = percent_non_hispanic_white) %>% 
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_black + p_hispanic)

sub_var21 =
  read_excel('data/ny_hr21.xlsx', sheet = 'Ranked Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>%
  select(county, percent_smokers, percent_adults_with_obesity, 
         food_environment_index, percent_physically_inactive, 
         percent_with_access_to_exercise_opportunities, 
         percent_excessive_drinking, 
         percent_driving_deaths_with_alcohol_involvement, 
         number_chlamydia_cases, teen_birth_rate, percent_unemployed) %>%
  rename(percent_obese = percent_adults_with_obesity,
         percent_with_access = percent_with_access_to_exercise_opportunities,
         percent_alcohol_impaired = 
           percent_driving_deaths_with_alcohol_involvement)

list_2021 =
  list(hr2021, demo2021, sub_var21)

total2021 = 
  list_2021 %>%
  reduce(full_join, by = "county") %>%
  mutate(year = 2021)

# 2022 HR Data
hr2022 = read_excel('data/ny_hr22.xlsx', 
                    sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2022 = read_excel('data/ny_hr22.xlsx', 
                      sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
    select('county', 
         'median_household_income', 
         'segregation_index',
         'percent_black',
         'percent_hispanic',
         'percent_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         segregation_score = segregation_index,
         p_black = percent_black,
         p_hispanic = percent_hispanic,
         p_white = percent_non_hispanic_white) %>% 
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_hispanic + p_black)

sub_var22 =
  read_excel('data/ny_hr22.xlsx', sheet = 'Ranked Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>%
  select(county, percent_smokers, percent_adults_with_obesity, 
         food_environment_index, percent_physically_inactive, 
         percent_with_access_to_exercise_opportunities, 
         percent_excessive_drinking, 
         percent_driving_deaths_with_alcohol_involvement, 
         number_chlamydia_cases, teen_birth_rate, percent_unemployed) %>%
  rename(percent_obese = percent_adults_with_obesity,
         percent_with_access = percent_with_access_to_exercise_opportunities,
         percent_alcohol_impaired = percent_driving_deaths_with_alcohol_involvement)

list_2022 =
  list(hr2022, demo2022, sub_var22)

total2022 = 
  list_2022 %>%
  reduce(full_join, by = "county") %>%
  mutate(year = 2022)

# Merge
hr_all = rbind(total2019, total2020, total2021, total2022)
```

3. **New York State COVID-19**  
From the three data sets we extracted the following variables of interest: number of new COVID cases per day, cumulative number of deaths reported per day, cumulative number of individuals who received the first dose of the vaccine. For the dataset with cumulative number of deaths, the county "Manhattan" was replaced with "New York" for consistency. Next, the three datasets were merged by "date" and "county." The merged dataset was then grouped according to "county" and "year" and the following variables were created: total number of new positive cases per year, called n_cases; total number of deaths per year, called n_deaths; and total number of individuals who received the first dose of the vaccine per year, called vax_dose1 (this data is not available for year 2020).

```{r, results = FALSE, message = FALSE, warnings = FALSE}
ny_test = read_csv('data/ny_covidtest.csv') %>% 
janitor::clean_names() %>% 
filter(geography == 'COUNTY') %>% 
select(-geography) %>% 
rename(date = test_date) %>% 
mutate(date = lubridate::mdy(date))  

ny_death = read_csv("data/ny_coviddeaths.csv") %>% 
janitor::clean_names() %>% 
rename(date = report_date, n_fatality = place_of_fatality) %>%
select(-deaths_by_county_of_residence) %>% 
mutate(date = lubridate::mdy(date), 
       county = replace(county, county == 'Manhattan', 'New York'))

ny_vax = read_csv("data/ny_covidvax.csv") %>% 
janitor::clean_names() %>% 
rename(date = report_as_of) %>% 
select(-region, -series_complete) %>% 
mutate(date = lubridate::mdy(date))

ny_covid_v1 = left_join(ny_test, ny_death, by = c("date", "county"))

covid_df_v1 = left_join(ny_covid_v1, ny_vax, by = c("date", "county")) %>% 
  separate(date, c("year", "month", "day"), sep = "-") %>% 
  mutate(year = as.numeric(year), 
         month = as.numeric(month), 
         day = as.numeric(day))

covid_df = covid_df_v1 %>% 
  group_by(year, county) %>% 
  summarise(n_cases = sum(new_positives),
            vax_dose1 = max(first_dose),
            n_deaths = max(n_fatality, na.rm = TRUE))
```

4. **Dataset for Analysis**  
For the first part of the regression tests, the demographics dataset, health ranking dataset, and COVID dataset were merged into one dataset called "comb." To comb, we added a new binary variable called vax_maj to see whether majority of the residents in the county had received the first dose of vaccine by 2022. The cutoff value used was 83% as it was reported that nearly ~83% of the US population had completed at least one dose of vaccine by November of 2022. [(source)](https://usafacts.org/visualizations/covid-vaccine-tracker-states/state/new-york)  

```{r, results = FALSE, message = FALSE}
covid_hr = left_join(covid_df, hr_all, by = c("county", "year")) 
comb = left_join(covid_hr, nys_df, by = 'county') %>% 
  mutate(tpop_50 = tpop/2,
         vax_maj = case_when(vax_dose1 >= .83*(tpop) ~ 1,
                             vax_dose1 < .83*(tpop) ~ 0))
```

5. **Dataset for Additional Analysis **  
For subanalysis, a new dataset was created by combining census demographics, NY COVID data, and subvariabes dataset from "Ranked Measure Data" sheet.

```{r, results = FALSE, message = FALSE}
sub_var_data =
  hr_all %>%
  select(-ends_with("_r"))

covid_hr = left_join(covid_df, sub_var_data, by = c("county", "year")) 

new_comb = left_join(covid_hr, nys_df, by = 'county')
```

## Exploratory Data Analysis

In order to have a better understanding of the existing socioeconomic and health factor status of the counties we conducted some exploratory data analysis mainly through visualization. We first tried to see which counties have the highest socio-economic and heath factor scores

### Bubble Plot
```{r}
bubble_df = comb %>% 
  select(year, county, health_beh_r, ses_r, tpop) %>% 
  filter(year == '2021')

library(plotly)
data = bubble_df %>%
  mutate(county = as.factor(county),
         health_beh_r = as.numeric(health_beh_r),
         ses_r = as.numeric(ses_r)) %>%
  janitor::clean_names()


total <- merge(bubble_df,NY_df,by="county")

fig <- plot_ly(total, x = ~health_beh_r, y = ~ses_r, text = ~county, 
               type = 'scatter',
               mode = 'markers', size = ~tpop.y, 
               color = ~county, colors = 'Paired',
               marker = list(opacity = 0.5, sizemode = 'diameter'))

fig <- fig %>% layout(title = 'Bubble Plot (Bubble Size = County Population)',
                      xaxis = list(title = 'Health Rank'),
                      yaxis = list(title = 'Socio-economic Rank'),
                      showlegend = FALSE)

fig
write.csv(total,"./data/eda_bubble.csv")

```

From the plot we can see that New York, Queens and Kings have the highest socio economic score, but have the lowest health factors ranks. The size of the bubble signifies total population of the county. Nassau, Suffolk, Westcher have low health and socio-ecnomic scores. 

### Chloropleth Map

Below is a chloropleth map that shows median age distribution and health county ranking in each county: 

```{r}
#library(sf)
#total = st_as_sf(total)
p = list()
p[[1]] = total %>%
  ggplot() +
  geom_sf(aes(fill = medage, geometry = geometry)) + 
  scale_fill_viridis_c(option = "viridis", name = "Median Age") +
  ggtitle("Median Age Per County in New York State")


p[[2]] = total %>%
  ggplot() +
  geom_sf(aes(fill = health_beh_r, geometry = geometry)) + 
  scale_fill_viridis_c(option = "viridis",name = "Health Rank") +
  ggtitle("Heath Rank Per County in New York State")

grid.arrange(p[[1]], p[[2]], nrow = 1)
```

On the left, we can see a chloropleth map of median age per county in NY. On the right, is a chloropleth map of health factor rank per county. Viewing the two plots side by side, we can see whether median age correlates with health county rank.

### Barplots

Before testing associations between county health factor ranking (HR) and COVID, we wanted to see rather there are any observable patterns between COVID cases & HR, COVID vaccination & HR, and COVID deaths & HR. County health factors ranking was categorized into 4 quartiles by ranks (quartile 1 = highest ranks quartile and quartile 4 = lowest ranks).[(source)](https://www.countyhealthrankings.org/reports/state-reports/2022-new-york-state-report)

```{r, message = FALSE, warning = FALSE}
eda1 = comb %>% 
  rename("Clinical Care" = clinical_care_r,
         "Physical Environment" = env_r,
         "Health Behaviors" = health_beh_r,
         "Social and Economic Factors" = ses_r) %>% 
  pivot_longer("Health Behaviors":"Physical Environment",
               names_to = "rank_var",
               values_to = "rank") %>% 
  filter(year == '2021') %>% 
  mutate(Quartile = case_when(rank < 17 ~ 'Quartile 4',
                              rank < 32 ~ 'Quartile 3',
                              rank < 46 ~ 'Quartile 2',
                              rank < 63 ~ 'Quartile 1')) %>% 
  mutate(Quartile = as.factor(Quartile)) 

p1 = ggplot(data=eda1, aes(x=rank_var, y=n_deaths, fill=Quartile)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Reds") + 
  theme_minimal() +
  labs(title="Number of COVID Deaths and County Health Factors by Quartile",
        x ="County Health Factors", y = "Number of Deaths")

p2 = ggplot(data=eda1, aes(x=rank_var, y=n_cases, fill=Quartile)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Oranges") + 
  theme_minimal() +
  labs(title="Number of COVID Cases and County Health Factors by Quartile",
        x ="County Health Factors", y = "Number of Cases")

p3 = ggplot(data=eda1, aes(x=rank_var, y=vax_dose1, fill=Quartile)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Greens") + 
  theme_minimal() +
  labs(title="Covid Vaccination (Dose 1) and County Health Factors by Quartile",
        x ="County Health Factors", y = "Number of People Vaccinated")

grid.arrange(p1, p2, p3, ncol = 1)
```

## Statistical Analysis

Note: Though we initially planned to adjust for racial diversity in our model, the variable was removed because racial diversity index did not vary much among counties. Also, tpop (total population) was replaced with pop_d (population density) as it was shown that COVID-19 incidence is strongly correlated with population density (Iderus et al., 2022). For the models, only data from 2021 or 2022 were used as there is no information on vaccination for 2020.

<p style="color: red">***Question 1: Are county health factors associated with COVID-19 risk?***</p>
Health factors--health behaviors, clinical care, physical environment, and socioeconomic factors--are community conditions that can be modified and improved through public health interventions or health policies. Therefore, we were interested in seeing which factor(s) is significantly associated with the number of COVID-19 cases, deaths, and vaccination. To do so, we ran multiple linear regression test.

### NYS County Health Factors and Covid Cases

$N_{Covid\_Cases} \sim \beta_{0} + \beta_{1} Health\_Behavior + \beta_{2} Clinical\_Care + \beta_{3} Physical\_Environment + \beta_{4} SES\_Factors + \beta_{5} Median\_Age + \beta_{6} Population\_Density + \epsilon$

```{r, message = FALSE, warning = FALSE}
m1 = comb %>% 
  filter(year == '2021') %>% 
  lm(n_cases ~ health_beh_r + clinical_care_r + env_r + ses_r + medage + 
       pop_d, data = .)

m1 %>% 
  broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Outbreak"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

After adjusting for median age and population density, only health behaviors ranking was shown to be significantly associated with the number of COVID-19 cases (p < .05). The estimate for health behavior ranking was -2399.531, indicating that counties with higher health behavior ranking have lower number of COVID cases.  

Health behaviors score is based on residents' tobacco use, diet & exercise, alcohol & drug use, and sexual activity (i.e., number of STI, teen pregnancy). These sub-factors are often viewed as drivers of health inequity. Rate of teen pregnancy is higher in majority-minority district; alcohol and drug abuse are more common among minorities; and residential segregation limits minorities' access to healthy food. Therefore, the results warrant further exploration of interactions between the health behaviors ranking, its sub-factors, and race/ethnicity.

To test the validity of our results, we checked regression assumptions.

```{r m1_check, message = FALSE, warning = FALSE}
par(mfrow = c(2,2))
plot(m1)
```

Test for linearity (residual vs. fitted values) does not show strong pattern; however, the points are not perfectly, randomly scattered around residual = 0. Test for influential observations (residual vs. leverage) shows that there is one influential point (#31), which should be tested to see whether it should be removed or kept. Test for homoscedasticity (scale-location) indicates potential heteroscedasticity. Lastly, test for normality of residuals (normal Q-Q plot) confirms that there is no extreme skewness in our data with  majority of the points falling along the line. Some deviations at the lowest and highest quantiles suggest that random fluctuation may be seen at extreme ends. Combined, the plots indicate that our model, though sufficient, can be improved (i.e., add interaction terms, adjust for more variables).

### NYS County Health Factors and Covid Fatalities

$N_{Deaths} \sim \beta_{0} + \beta_{1} Health\_Behavior + \beta_{2} Clinical\_Care + \beta_{3} Physical\_Environment + \beta_{4} SES\_Factors + \beta_{5} Population\_Density + \beta_{6} Median\_Age + \epsilon$
```{r, message = FALSE, warning = FALSE}
m2 = comb %>% 
  filter(year == '2021') %>% 
  lm(n_deaths ~ health_beh_r + clinical_care_r + env_r + ses_r + pop_d + 
       medage, data = .)

m2 %>% 
broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Deaths"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

As seen with model 1, model 2 shows that only health behaviors ranking is significantly associated with the number of COVID deaths in each county (p < .05). The estimate is -43.684, meaning that counties with better health behaviors ranking had less number of COVID deaths. The finding suggests that public health professionals should aim to mitigate disparities in COVID-19 by first starting short-term community-based interventions that encourage residents to build healthier lifestyles and make healthier life choices.

```{r m2_check, message = FALSE, warning = FALSE}
par(mfrow = c(2,2))
plot(m2)
```

Results of regression assumption tests are similar to that of model 1's, indicating that there is more to be explored in the association between health factor and COVID-19 fatalities. Once again, point 31 is observed to be an outlier and needs to be tested further.

### NYS County Health Factors and Vaccination (Dose 1)

$Vaccine\_Dose1 \sim \beta_{0} + \beta_{1} Health\_Behavior + \beta_{2} Clinical\_Care + \beta_{3} SES\_Factors + \beta_{4} Physical\_Environment + \beta_{5} Population\_Density + \epsilon$

```{r, message = FALSE, warning = FALSE}
m3 = comb %>% 
  filter(year == '2022') %>% 
  lm(vax_dose1 ~ health_beh_r + clinical_care_r + ses_r + env_r + pop_d, data = .,)

m3 %>% 
  broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Vaccination (Dose # 1)"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

In this model, we did not adjust for median age since COVID-19 vaccination rate did not vary significantly for 18+ by 2022. As seen in models 1 and 2, model 3 once again showed that county's health behaviors rank is significantly associated with the number of individuals who received the first dose of the vaccine (p < .05). Once again, the estimate is negative (-11691). This implies that individuals who take care of their health holistically are more likely to receive the vaccine.

```{r m3_check, message = FALSE, warning = FALSE}
par(mfrow = c(2,2))
plot(m3)
```

Regression assumption tests, once again, show room for improvement in our model and the need to test the outliers, especially point #31.

<p style="color: red">***Question 2: Can race/ethnicity or socioeconomic status in counties help determine COVID-19 severity?***</p>

### Socioeconomic Factors, Race/Ethnicity and Vaccination Rate

$Vaccination \sim \beta_{0} + \beta_{1} Segregation\_Score + \beta_{2} Median\_Income + \beta_{3} Percent\_Minority + \beta_{4} Population\_Density + \epsilon$


```{r, message = FALSE, warning = FALSE, echo = FALSE}
m4 = comb %>% 
  filter(year == '2022') %>% 
  glm(vax_maj ~ segregation_score + median_income + p_minority + pop_d, data = .)

m4 %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         OR_CI_lower = exp(estimate - 1.96*(std.error)),
         OR_CI_upper = exp(estimate + 1.96*(std.error))) %>% 
  select(term, log_OR = estimate, OR, OR_CI_lower, OR_CI_upper, p.value) %>% 
  kbl(
    caption = "SES Factors & COVID Vaccination"
    , col.names = c("Predictor", "Estimate", "OR", "OR CI, low", "OR CI, high", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

Based on the the results, median_income and p_minority are significantly associated with higher chance of majority of the county's resident being vaccinated (p < .05). However, despite being statistically significant, because the estimates are ~0 and ORs are also ~1, the significance is not meaningful. Therefore, though SES factors may contribute, their effects, perhaps, are not as pronounced unless combined with geographical proximity to locations with COVID-19 outbreak.

Upon checking our model,

```{r m4_check, message = FALSE, warning = FALSE}
par(mfrow = c(2,2))
plot(m4)
```

we did see the need to adjust our model; however, with the lack of 2022 data and demographics information, further analysis and modifications could not be completed. The residual vs. fitted plot did not give us much information as the outcome variable of our model is binary. The normal Q-Q plot showed that our data is not skewed, though there are deviations at extreme quantiles. Furthermore, there appears to be potential heteroscedasticity per scale-location plot and one outlier (point #3 falls outside Cook's distance). 

### Socioeconomic factors, Race/Ethnicity and COVID Fatalities

$N_{Deaths} \sim \beta_{0} + \beta_{1} Segregation\_Score + \beta_{2} Percent\_Minority + \beta_{3} Median\_Income + \beta_{4} Median\_Age + \beta_{5} Population\_Density + \epsilon$

```{r, message = FALSE, warning = FALSE}
m5 = comb %>% 
  filter(year == '2021') %>% 
  lm(n_deaths ~ segregation_score + p_minority + median_income + medage + pop_d,
     data = .)

m5 %>% 
  broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "SES Factors & COVID Deaths"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

This model shows that the number of COVID-19 fatalities in each county is significantly associated with segregation score, % minority (black and Hispanic), and median income (p <= .05) after adjusting for population density. Segregation score had a positive estimate of 17.565, indicating that residential segregation of white vs. non-white could have played a role in exacerbating the COVID-19 disparity. Positive estimate for % minority (estimate = 44.441) reinforces this notion. As for median income, because the estimate is ~0, despite statistical significance, meaningful interpretation is lacking. These findings demonstrate that racial/ethnic minorities, specifically Hispanic and Black, had a higher risk of dying from COVID compared to White/Asian.

```{r m5_check, message = FALSE, warning = FALSE}
par(mfrow = c(2,2))
plot(m5)
```

For regression test plots, the conclusions are very similar to that of model 4's. The residual vs. fitted plot does not show clear patterns; however, the points are also not equally, randomly distributed along residual = 0 line. The Q-Q plot confirms our data is normally distributed with no extreme skewness. Scale-location shows possibility of homoscedasticity violation and residual vs. leverage, shows that points #3 and #31 are influential observations; combined with model 1 to model 4, this indicates that points 3 and 31 should be identified and tested to determine whether they should be kept or removed from our dataset.

### Subanalysis: Health Behavior Subfactors & COVID Vaccination (Dose 1)

<p style="color: red">***Question 3: Are county percentages of smokers, obesity, physical inactivity, and excessive alcohol drinking associated with receiving at least the first dose of any COVID-19 vaccine?***</p>

The health behaviors ranking was a significant predictor of having increases in the amount of people who have had at least their first dose of the COVID-19 vaccine. The health behaviors ranking encompasses a broad array of sub-variables. Of particular interest to explore are well-known factors such as smoking, obesity, exercise, and alcohol consumption. All these factors are well-established predictors of many existing health conditions such as CVD, diabetes, cancer, etc. Therefore, we are now interested in seeing whether these factors affect the attainment of getting at least the first dose of the COVID vaccine. 

$Vaccine\_Dose1 \sim \beta_{0} + \beta_{1} percent\_smokers + \beta_{2} percent\_obese + \beta_{3} percent\_physically\_inactive + \beta_{4} percent\_excessive\_drinking$

```{r}
subm1 =
  new_comb %>%
  filter(year == '2021') %>%
  lm(vax_dose1 ~ percent_smokers + percent_obese + percent_physically_inactive + percent_excessive_drinking, data = .)

subm1 %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Vaccination (Dose # 1)"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

From the results, we can see that every predictor has a significant p-value of less than 0.05, except for the variable `percent_excessive_drinking`. The negative estimates for smokers and obesity suggests that for each percent increase in the adults with obesity or smoking, the amount of people in that county who have at least the first dose of a COVID vaccine decreases. However, for the variables for physical inactivity, the estimate is positive. The estimates in this model are not completely reliable as our COVID outcomes (cases, deaths, and first dose of vaccine) is dependent on geospacial factors. Our data is by county and not by individuals which have an influence on the results. Further analysis is necessary on the group level to get more precise estimates.

## Spatial Analysis

```{r}
ny_covid = read.csv('data/covid_testing.csv')  %>%
  janitor::clean_names()

###############################
ny_covid$test_date = lubridate::mdy(ny_covid$test_date)
##############################
total <- merge(ny_covid,NY_df,by="county")


```


```{r}

mon = seq(as.Date("2021-01-01"), as.Date("2022-01-01"), by = "3 months")
df_list = list()
# loop version 2
for (i in 1:4) {
  sub_df = total[total$test_date >= mon[[i]] & total$test_date <= mon[[i+1]], ]
  group_df =  sub_df %>% group_by(county)  %>%
    summarise(total_covid = sum(new_positives),
              pop = sum(tpop)/as.numeric(mon[i+1]-mon[i]))
  df = dplyr :: left_join(group_df, NY_df, by = 'county')
  df_list[[i]] = df
}


p <- list()
for(i in 1:4){
  p[[i]] <- df_list[[i]] %>%
    ggplot() +geom_sf(aes(fill = total_covid/pop, geometry = geometry)) + 
    scale_fill_viridis_c(option = "magma", name = "Incidence",
                         direction = -1) +
    ggtitle(paste(mon[[i]],"to", mon[[i+1]]))
}

do.call(grid.arrange,p)

```

The above 4 chloroplast maps are a quarterly incidence of COVID-19 per county. Visualizing incidence can help public professionals retrospectively inspect which factors could've caused a spikes in different counties.

## Autoregression

```{r}
ny_covid = read.csv('data/covid_testing.csv')  %>%
  janitor::clean_names()

######################################################
ny_covid$test_date = lubridate::mdy(ny_covid$test_date)
sub_df = ny_covid[ny_covid$county == 'New York City', ]
sub_df<- sub_df[seq(dim(sub_df)[1],1),]

ggplot(sub_df, aes(x=test_date, y=new_positives)) + 
  geom_point(alpha = 10/100, colour = "red") + 
  scale_x_date(date_labels = "%m-%Y") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(title = "New positive covid cases per month in NYC")

```
The above plot is a scatter plot of the daily positive cases in New York City from March 2020 up-till now. We can see the wave like trend, especially from hill shaped curves at the start of the 2020, start of 2021, start of 2022 when it peaked around mid 2022. This implies the existence of auto regressive behavior which we were interested to investigate. To better understand the auto-regressive trend we built an Autocorrelation Function (ACF) plot and Partial Autocorrelation Function (PACF) plot. The ACF and PACF plots are used to figure out the order of autoregressive (AR) models. ACF gives us values of auto-correlation of any series with its lagged values whereas PACF finds correlation of the residuals that remains after removing the effects which are already explained by the earlier lag(s). The partial autocorrelation at lag k is the autocorrelation between X_t_t and X_(t-k) that is not accounted for by lags 1 through k−1. 


```{r}
library(forecast)
library(ggplot2)

conf.level <- 0.95
ciline <- qnorm((1 - conf.level)/2)/sqrt(length(sub_df$new_positives))

############# ACF ####################
bacf <- acf(sub_df$new_positives, plot = FALSE)
bacfdf <- with(bacf, data.frame(lag, acf))

p1 <- ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
       geom_bar(stat = "identity", position = "identity") +
  ggtitle("Autocorrelation Plot")


########### PACF ###################
bacf <- pacf(sub_df$new_positives, plot = FALSE)
bacfdf <- with(bacf, data.frame(lag, acf))


p2 <- ggplot(data=bacfdf, mapping=aes(x=lag, y=acf)) +
  geom_bar(stat = "identity", position = "identity",fill="lightblue")  +
  ggtitle("Partial Autocorrelation Plot")

grid.arrange(p1,p2)

```
Both the ACF and PACF start with a lag of 0, which is the correlation of the time series with itself and therefore results in a correlation of 1. However after a lag of 1, as stated previously, ACF gives us values of auto-correlation of any series with its lagged values whereas PACF finds correlation of the residuals that remains after removing the effects which are already explained by the earlier lag(s). Thus PACF might be a better indicator of how many lag terms to keep. In our case we decided to move with the 8 lag terms since they seem to have significant partial autcorrelation with value at lag = 0 (present value).

```{r}
reg1 = arima(sub_df$new_positives, order = c(8,0,0))
summary(reg1)
```

The coefficients for an AR(8) model represent the weights that are applied to the past 8 values of the time series (i.e. $y_{t-1}$, $y_{t-2}$, $y_{t-3}$, $y_{t-4}$, $y_{t-5}$, $y_{t-6}$, $y_{t-7}$, $y_{t-8}$) in order to predict the next value of the time series ($\hat{y}_t$). In this case, the coefficients are as follows:

These coefficients can be used to write the ARIMA (8,0,0) equation as follows:

$\hat{y}t = \alpha_1 y{t-1} + \alpha_2 y_{t-2} + \alpha_3 y_{t-3} + \alpha_4 y_{t-4} + \alpha_5 y_{t-5} + \alpha_6 y_{t-6} + \alpha_7 y_{t-7} + \alpha_8 y_{t-8} + \beta_0$

$\begin{aligned} \hat{y}t &= 1.0562 \cdot y_{t-1} - 0.2312 \cdot y_{t-2} + 0.0948 \cdot y_{t-3} + 0.0779 \cdot y_{t-4} - 0.1035 \cdot y_{t-5} + 0.1343 \cdot y_{t-6} + 0.3918 \cdot y_{t-7} - 0.4517 \cdot y_{t-8} + 2924.354 \end{aligned}$

This equation can be used to predict the next value of the time series, $\hat{y}_t$, based on the past 8 values of the time series. The coefficients in the equation represent the relative importance of each of the past values in predicting the next value.

Plotting the fitted values alongside the positive covid cases:
```{r}
ar = fitted(reg1)
ggplot(sub_df, aes(x=test_date, y=new_positives)) + 
  geom_point(alpha = 20/100, color = "red") + 
  scale_x_date(date_labels = "%m-%Y",date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(title = "Scatter Plot of Daily Postive Cases in New York City from 2020-2022
       with ARIMA trend line", x= "Test Date",
       y = 'Positive Cases Detected') +
  geom_line(aes(y=ar,color = "ARIMA trend line")) +  
  scale_color_manual(values = c("ARIMA trend line" = "black"),
                                          labels = "Fitted Arima Model") 

```

## Discussions 

Initially, one of our objectives was to test association between county health factors (health behaviors, physical environment, SE factors, and clinical care) and COVID-19 by treating the county health factors' ranking as a substitute for county health factors' scores. However, as we began to run regression tests, we realized that health factors rankings are not ideal predictors. By limiting our analysis to per year and NY state counties, we only had 62 observations. The small sample size resulted in weak models, as seen with regression assumptions tests. Furthermore, surprisingly, important health factors such as the level of clinical care and SE factors were not significant predictors of the number of COVID deaths, cases, or vaccinations. Connecting this to our autocorrelation plots and COVID's infectiousness, this suggests that our model needs to adjust for geographical location (i.e., each county's distance from NYC, the epicenter of COVID). Additionally, points 3 and 31 were observed to be common influential point(s) in health ranking and SE/race and ethnicity models. Therefore, this suggests the need to identify which counties points 3 and 31 correspond to and the need to test these counties further to decide whether they should be kept or removed from the model.In-terms of the temporal association we successfully depicted strong Auto-Regressive behavior, and were able to build a model to help public health officials to predict covid cases in the short term. Furthermore, the shiny app can be really useful as a tool in visualizing the variation in Covid incidence and risk per county in NY State can be used by Public Health Officials to develop targeted interventions. 


## Conclusion 

Health behavior modifiable --> significant predictor of covid vaccination, cases, and deaths. Median income