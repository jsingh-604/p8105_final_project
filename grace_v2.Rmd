---
title: "r_final_proj"
output: github_document
---

```{r setup, include=FALSE}
library(data.table)
library(tidycensus)
library(tidyverse)
library(ggridges)
library(patchwork)
library(viridis)
library(modelr)
library(mgcv)
library(readxl)
library(plotly)
library(kableExtra)
library(rvest)
library(xml2)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%")

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis")

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Part I: Observing/Cleaning Data

## 2020 Census Data: Load & Clean (2021 data N/A as it is relased on 12/8)

1. Load Data
2. Choose variables
3. Create a data frame named nys_df
```{r census_data, message = FALSE}
census_api_key("aa512886c5449a582d837da8d3a07af66a043fe5")

census_data <- load_variables(2020, "acs5", cache=T)
fwrite(census_data, "census_variables.csv")

vars <- c(tpop = 'P001001',
          medage = 'P013001',
          wpop = 'P003002',
          bpop = 'P003003',
          apop = 'P003005',
          aipop = 'P003004',
          nhpop = 'P003006',
          sopop = 'P003007',
          mpop = 'P003008',
          hpop = 'P004003')

nys_df <- get_decennial(state = "ny", 
                       geography = "county",
                       variables = vars,
                       geometry = T,
                       output = "wide")

nys_df = nys_df %>%
  mutate(
    county = gsub(" County, New York","",NAME))

#di = diversity index (eq from census website)

nys_df$di <- (1 - ((nys_df$hpop/nys_df$tpop)^2 
                   + (nys_df$wpop/nys_df$tpop)^2 
                   + (nys_df$aipop/nys_df$tpop)^2 
                   + (nys_df$apop/nys_df$tpop)^2 
                   + (nys_df$nhpop/nys_df$tpop)^2 
                   + (nys_df$sopop/nys_df$tpop)^2 
                   + (nys_df$mpop/nys_df$tpop)^2))*100

nys_df = nys_df %>% 
  select(tpop, medage, county, di)
```

## NY County Land Area
```{r}
area = read_excel('./data/pop_density.xlsx') %>% 
  janitor::clean_names() %>% 
  rename(area = value)
```

```{r}
nys_df = left_join(nys_df, area, by = 'county') %>% 
  mutate(pop_d = tpop/area)
```


## 2019-2022 Health Ranking (HR) Data: Load & Clean

### 2019 HR Data

```{r} 
hr2019 = read_excel('data/ny_hr19.xls', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2019 = read_excel('data/ny_hr19.xls', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'segregation_index_2',
         'household_income',
         'percent_hispanic',
         'percent_african_american',
         'percent_non_hispanic_white') %>% 
  rename(median_income = household_income,
         segregation_score = segregation_index_2,
         p_hispanic = percent_hispanic,
         p_black = percent_african_american,
         p_white = percent_non_hispanic_white) %>%
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_black + p_hispanic)

total2019 = merge(x = hr2019, y = demo2019, by = "county", all.x = TRUE) %>% 
  mutate(year = 2019)
```

### 2020 HR Data

```{r, message = FALSE}
hr2020 = read_excel('data/ny_hr20.xlsx', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2020 = read_excel('data/ny_hr20.xlsx', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'median_household_income', 
         'segregation_index_2',
         'percent_black',
         'percent_hispanic',
         'percent_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         segregation_score = segregation_index_2,
         p_black = percent_black,
         p_hispanic = percent_hispanic,
         p_white = percent_non_hispanic_white) %>% 
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_black + p_hispanic)

total2020 = merge(x = hr2020, y = demo2020, by = "county", all.x = TRUE) %>% 
  mutate(year = 2020)
```

### 2021 HR Data

```{r}
hr2021 = read_excel('data/ny_hr21.xlsx', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2021 = read_excel('data/ny_hr21.xlsx', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'median_household_income', 
         'segregation_index_2',
         'percent_non_hispanic_white',
         'percent_black',
         'percent_hispanic') %>% 
  rename(median_income = median_household_income, 
         segregation_score = segregation_index_2,
         p_black = percent_black,
         p_hispanic = percent_hispanic,
         p_white = percent_non_hispanic_white) %>% 
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_black + p_hispanic)

total2021 = merge(x = hr2021, y = demo2021, by = "county", all.x = TRUE) %>%
  mutate(year = 2021)
```

### 2022 HR Data:

Health Ranking Data
```{r, message = FALSE}
hr2022 = read_excel('data/ny_hr22.xlsx', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-starts_with("z"), -fips, -state) %>% 
  rename(longevity_r = rank_5,
         qol_r = rank_7,
         health_beh_r = rank_9,
         clinical_care_r = rank_11,
         ses_r = rank_13,
         env_r = rank_15)

demo2022 = read_excel('data/ny_hr22.xlsx', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
    select('county', 
         'median_household_income', 
         'segregation_index',
         'percent_black',
         'percent_hispanic',
         'percent_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         segregation_score = segregation_index,
         p_black = percent_black,
         p_hispanic = percent_hispanic,
         p_white = percent_non_hispanic_white) %>% 
    mutate(segregation = case_when(segregation_score < 30 ~ 0,
                                 segregation_score >= 30 ~ 1),
           p_minority = p_hispanic + p_black)

total2022 = merge(x = hr2022, y = demo2022, by = "county", all.x = TRUE) %>% 
  mutate(year = 2022)
```

Combine 2019-2022
```{r}
hr_all = rbind(total2019, total2020, total2021, total2022)
```

## Load 2020 to November 2022 NY COVID-19 Data

Decided to look at variables related to covid testing (i.e., # positive cases, # tests performed), covid vaccination rate, and covid-related fatalities  
1. Import 3 separate csv files (ny_covidtest, ny_coviddeaths, ny_covidvax)
3. Select variables of interest
4. Merge 3 data frames into one by `date` and `county`
5. Convert `date` data type from char to date
6. Separate date into day, month, & year for analysis

```{r, message = FALSE}
ny_test = read_csv('data/ny_covidtest.csv') %>% 
janitor::clean_names() %>% 
filter(geography == 'COUNTY') %>% 
select(-geography) %>% 
rename(date = test_date) %>% 
mutate(date = lubridate::mdy(date))  

ny_death = read_csv("data/ny_coviddeaths.csv") %>% 
janitor::clean_names() %>% 
rename(date = report_date, n_fatality = place_of_fatality) %>%
select(-deaths_by_county_of_residence) %>% 
mutate(date = lubridate::mdy(date), county = replace(county, county == 'Manhattan', 'New York'))

ny_vax = read_csv("data/ny_covidvax.csv") %>% 
janitor::clean_names() %>% 
rename(date = report_as_of) %>% 
select(-region, -series_complete) %>% 
mutate(date = lubridate::mdy(date))

ny_covid_v1 = left_join(ny_test, ny_death, by = c("date", "county"))

covid_df_v1 = left_join(ny_covid_v1, ny_vax, by = c("date", "county")) %>% 
  separate(date, c("year", "month", "day"), sep = "-") %>% 
  mutate(year = as.numeric(year), month = as.numeric(month), day = as.numeric(day))

covid_df = covid_df_v1 %>% 
  group_by(year, county) %>% 
  summarise(n_cases = sum(new_positives),
            vax_dose1 = max(first_dose),
            n_deaths = max(n_fatality, na.rm = TRUE))
```

## Merge Data for Analysis

```{r}
covid_hr = left_join(covid_df, hr_all, by = c("county", "year"))
comb = left_join(covid_hr, nys_df, by = 'county') %>% 
  mutate(tpop_50 = tpop/2,
         vax_maj = case_when(vax_dose1 >= .79*(tpop) ~ 1,
                             vax_dose1 < .79*(tpop) ~ 0))
```


```{r}
# Regression Test:

# residual vs. leverage -- test for influential points. No points falls outside Cook's distance, indicating there are no major outliers

# residual vs. fitted -- no strong trend, so okay but demonstrates that there is more to be explored.

# normal q-q -- since most points fall along the line, no extreme skewness and the data is fairly normally distributed. Several deviations at the lowest/highest quartile indicate that random fluctuations may be seen at extreme ends.

# scale-location -- homoscedascity off
```

### Models 1 & 2 -- Health Factor/Outcome Ranking & COVID

Model 1
* x = health factor variables, median age, 
* y = number of covid cases in 2021

```{r}
m1 = comb %>% 
  filter(year == '2021') %>% 
  lm(n_cases ~ health_beh_r + clinical_care_r + env_r + ses_r + medage + pop_d, data = .)

m1 %>% 
  broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Outbreak"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = FALSE)

plot(m1)
```


```{r}
m2 = comb %>% 
  filter(year == '2021') %>% 
  lm(n_deaths ~ health_beh_r + clinical_care_r + env_r + ses_r + pop_d + medage, data = .)

m2 %>% 
broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Deaths"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = FALSE)

plot(m2)
```


Model 3
```{r}
m3 = comb %>% 
  filter(year == '2022') %>% 
  lm(vax_dose1 ~ health_beh_r + clinical_care_r + ses_r + env_r + pop_d, data = .,)

m3 %>% 
  broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "Health Factor Ranking & COVID Vaccination (Dose # 1)"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = FALSE)

plot(m3)
```

### Models 4 to 6 -- SES, Race/Ethnicity & COVID

Chi-Square Test -- Segregation Index and Covid Vaccination Rate

We predicted that 

```{r}

```

```{r}
m4 = comb %>% 
  filter(year == '2022') %>% 
  glm(vax_maj ~ segregation_score + median_income + p_minority + pop_d, data = .)

plot(m4)

summary(m4)

m4 %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         OR_CI_lower = exp(estimate - 1.96*(std.error)),
         OR_CI_upper = exp(estimate + 1.96*(std.error))) %>% 
  select(term, log_OR = estimate, OR, OR_CI_lower, OR_CI_upper, p.value) %>% 
  kbl(
    caption = "SES Factors & COVID Vaccination"
    , col.names = c("Predictor", "Estimate", "OR", "OR CI, low", "OR CI, high", "p-value")
    , digits = 5) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = FALSE)
```

## Chi-Square Test -- Vacc


Model 5
```{r}
m5 = comb %>% 
  filter(year == '2021') %>% 
  lm(n_deaths ~ segregation + p_minority + median_income + medage + pop_d, data = .)

plot(m5)

m5 %>% 
  broom::tidy() %>%
  select(term, estimate, p.value) %>% 
  kbl(
    caption = "SES Factors & COVID Deaths"
    , col.names = c("Predictor", "Estimate", "p-value")
    , digits = 3) %>% 
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = FALSE)
```

```{r}
plot_df = comb %>% 
  pivot_longer(health_beh_r:env_r,
               names_to = "rank_var",
               values_to = "rank") %>% 
  filter(year == "2021")

#health
d_beh = plot_df %>% 
  filter(rank_var == "health_beh_r")

d_beh %>%
  mutate(text_label = str_c("Name: ", dba, "\nZip Code: ", zipcode)) %>% 
  plot_ly(x = ~grade, y = ~score, color = ~boro, text = ~text_label, alpha = .5, 
          type = "scatter", mode = "markers", colors = "plasma")
```

```{r EDA PLOT}
eda2 = comb %>% 
  pivot_longer(health_beh_r:env_r,
               names_to = "rank_var",
               values_to = "rank") %>% 
  filter(year == '2021') %>% 
  mutate(quartile = case_when(rank < 17 ~ 'q4',
                              rank < 32 ~ 'q3',
                              rank < 46 ~ 'q2',
                              rank < 63 ~ 'q1')) %>% 
  mutate(quartile = as.factor(quartile))

p1 = ggplot(data=eda2, aes(x=rank_var, y=n_deaths, fill=quartile)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Reds") + 
  theme_minimal() +
  labs(title="Number of COVID Deaths and County Health Factors by Quartile",
        x ="County Health Factors", y = "Number of Deaths")

p1

p2 = ggplot(data=eda2, aes(x=rank_var, y=n_cases, fill=quartile)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Greens") + 
  theme_minimal() +
  labs(title="Number of COVID Cases and County Health Factors by Quartile",
        x ="County Health Factors", y = "Number of Cases")

p2

p3 = ggplot(data=eda2, aes(x=rank_var, y=vax_dose1, fill=quartile)) +
  geom_bar(stat="identity", position=position_dodge())+
  scale_fill_brewer(palette="Oranges") + 
  theme_minimal() +
  labs(title="Covid Vaccination (Dose 1) and County Health Factors by Quartile",
        x ="County Health Factors", y = "Number of Cases")

p3
```


