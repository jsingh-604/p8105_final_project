---
title: "r_final_proj"
output: github_document
---

```{r setup, include=FALSE}
library(data.table)
library(tidycensus)
library(tidyverse)
library(ggridges)
library(patchwork)
library(viridis)
library(modelr)
library(mgcv)
library(readxl)
library(plotly)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%")

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis")

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Part I: Observing/Cleaning Data

## Census Data: Load & Clean

1. Load Data
2. Choose variables
3. Create a data frame named ny_df
```{r census_data, message = FALSE}
census_api_key("aa512886c5449a582d837da8d3a07af66a043fe5")

census_data <- load_variables(2019, "acs5", cache=T)
fwrite(census_data, "census_variables.csv")

vars <- c(tpop = 'P001001',
          medage = 'P013001',
          wpop = 'P003002',
          bpop = 'P003003',
          apop = 'P003005',
          hpop = 'P004003')

ny_df <- get_decennial(state = "ny", 
                       geography = "county",
                       variables = vars,
                       geometry = T,
                       output = "wide")

ny_df = ny_df %>%
  mutate(
    county = gsub(" County, New York","",NAME))

###Compute Simpson's Diversity Index **D = ((SUM n(n-1))/N(N-1))**
###Higher value indicates higher diversity

ny_df$race_div <- 1 - (((ny_df$wpop*(ny_df$wpop-1))+
                          (ny_df$bpop*(ny_df$bpop-1))+
                          (ny_df$hpop*(ny_df$hpop-1))+
                          (ny_df$apop*(ny_df$apop-1)))/
                         (ny_df$tpop*(ny_df$tpop-1)))

ny_df = ny_df %>% 
  select(tpop, medage, county, race_div)
```

## 2019-2022 Health Ranking (HR) & Demographics Data: Load & Clean

1. Load data using `read_excel`
2. Select sheets: ooutcomes & factors subrankings (contains HR data), additional measure data (contains demographics data)
3. Filter so only variables of interest (i.e., race/ethnicity, SES data, etc. are included)
4. Rename variables
5. Merge so demographics & HR data are in one data frame

### 2019 HR & Demogrphics (DO WE NEED 2019??)

Health Ranking Data
```{r} 
hr2019 = read_excel('grace/ny_hr19.xls', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-ends_with("z"), -fips) %>% 
  rename(longevity_r = length_of_life_rank,
         qol_r = quality_of_life_rank,
         health_beh_r = health_beh_rank,
         clinical_care_r = clinical_care_rank,
         ses_r = ses_rank,
         env_r = physical_env_r)
```

Demographics Data
```{r}
demo2019 = read_excel('grace/ny_hr19.xls', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'segregation_index_2',
         'number_uninsured_55',
         'number_uninsured_59',
         'household_income', 
         'number_african_american', 
         'number_american_indian_alaskan_native', 
         'number_asian', 
         'number_native_hawaiian_other_pacific_islander', 
         'number_hispanic', 
         'number_non_hispanic_white') %>% 
  rename(median_income = household_income,
         n_black = number_african_american,
         n_aian = number_american_indian_alaskan_native,
         n_asian = number_asian,
         n_nhpi = number_native_hawaiian_other_pacific_islander,
         n_hispanic = number_hispanic,
         n_white = number_non_hispanic_white,
         segregation_score = segregation_index_2) %>% 
  mutate(n_uninsured = number_uninsured_55 + number_uninsured_59)
```

Merge HR & Demo Data Frames
```{r}
merge2019 = merge(x = hr2019, y = demo2019, by = "county", all.x = TRUE)
```

### 2020 HR & Demogrphics 

Health Ranking Data
```{r, message = FALSE}
hr2020 = read_excel('grace/ny_hr20.xlsx', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-ends_with("z"), -fips) %>% 
  rename(longevity_r = length_of_life_rank,
         qol_r = quality_of_life_rank,
         health_beh_r = health_beh_rank,
         clinical_care_r = clinical_care_rank,
         ses_r = ses_rank,
         env_r = physical_env_r)
```

Demographics Data
```{r}
demo2020 = read_excel('grace/ny_hr20.xlsx', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'median_household_income', 
         'segregation_index_2',
         'number_uninsured_135',
         'number_uninsured_139',
         'number_black', 
         'number_american_indian_alaska_native', 
         'number_asian', 
         'number_native_hawaiian_other_pacific_islander', 
         'number_hispanic', 
         'number_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         n_black = number_black, 
         n_aian = number_american_indian_alaska_native, 
         n_asian = number_asian, 
         n_nhpi = number_native_hawaiian_other_pacific_islander, 
         n_hispanic = number_hispanic, 
         n_white = number_non_hispanic_white,
         segregation_score = segregation_index_2) %>% 
  mutate(n_uninsured = number_uninsured_135 + number_uninsured_139)
```

Merge
```{r}
merge2020 = merge(x = hr2020, y = demo2020, by = "county", all.x = TRUE) %>% 
  mutate(year = 2020)
```

### 2021 HR & Demographics

Health Ranking Data
```{r, message = FALSE}
hr2021 = read_excel('grace/ny_hr21.xlsx', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-ends_with("z"), -fips) %>% 
  rename(longevity_r = length_of_life_rank,
         qol_r = quality_of_life_rank,
         health_beh_r = health_beh_rank,
         clinical_care_r = clinical_care_rank,
         ses_r = ses_rank,
         env_r = physical_env_r)
```

Demographics Data
```{r, message = FALSE}
demo2021 = read_excel('grace/ny_hr21.xlsx', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county', 
         'median_household_income', 
         'segregation_index_2',
         'number_uninsured_135',
         'number_uninsured_139',
         'number_black', 
         'number_american_indian_alaska_native', 
         'number_asian', 
         'number_native_hawaiian_other_pacific_islander', 
         'number_hispanic', 
         'number_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         n_black = number_black, 
         n_aian = number_american_indian_alaska_native, 
         n_asian = number_asian, 
         n_nhpi = number_native_hawaiian_other_pacific_islander, 
         n_hispanic = number_hispanic, 
         n_white = number_non_hispanic_white,
         segregation_score = segregation_index_2) %>% 
  mutate(n_uninsured = number_uninsured_135 + number_uninsured_139)
```

Merge
```{r, message = FALSE}
merge2021 = merge(x = hr2021, y = demo2021, by = "county", all.x = TRUE) %>% 
  mutate(year = 2021)
```

### 2022 HR & Demographics

Health Ranking Data
```{r, message = FALSE}
hr2022 = read_excel('grace/ny_hr22.xlsx', sheet = 'Outcomes & Factors SubRankings', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select(-ends_with("z"), -fips) %>% 
  rename(longevity_r = length_of_life_rank,
         qol_r = quality_of_life_rank,
         health_beh_r = health_beh_rank,
         clinical_care_r = clinical_care_rank,
         ses_r = ses_rank,
         env_r = physical_env_r)
```

Demographics Data
```{r, message = FALSE}
demo2022 = read_excel('grace/ny_hr22.xlsx', sheet = 'Additional Measure Data', skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-c(1)) %>% 
  select('county',
         'median_household_income', 
         'segregation_index',
         'number_uninsured_137',
         'number_uninsured_141',
         'number_black', 
         'number_american_indian_alaska_native', 
         'number_asian', 
         'number_native_hawaiian_other_pacific_islander', 
         'number_hispanic', 
         'number_non_hispanic_white') %>% 
  rename(median_income = median_household_income, 
         n_black = number_black, 
         n_aian = number_american_indian_alaska_native, 
         n_asian = number_asian, 
         n_nhpi = number_native_hawaiian_other_pacific_islander, 
         n_hispanic = number_hispanic, 
         n_white = number_non_hispanic_white,
         segregation_score = segregation_index) %>% 
  mutate(n_uninsured = number_uninsured_137 + number_uninsured_141)
```

Merge
```{r, message = FALSE}
merge2022 = merge(x = hr2022, y = demo2022, by = "county", all.x = TRUE) %>% 
  mutate(year = 2022)
```

## Importing 2020 to November 2022 NY COVID-19 Data

Decided to look at variables related to covid testing (i.e., # positive cases, # tests performed), covid vaccination rate, and covid-related fatalities  
1. Import 3 separate csv files (ny_covidtest, ny_coviddeaths, ny_covidvax)
3. Select variables of interest
4. Merge 3 sdata framess into one by `date` and `county`
5. Convert `date` data type from char to date
6. Separate date into day, month, & year for analysis

```{r, message = FALSE}
## 2020 n_fatality availbable in demographics dataset? How to merge?

ny_test = read_csv('grace/ny_covidtest.csv') %>% 
janitor::clean_names() %>% 
filter(geography == 'COUNTY') %>% 
select(-geography) %>% 
rename(date = test_date) %>% 
mutate(date = lubridate::mdy(date))  

ny_death = read_csv("grace/ny_coviddeaths.csv") %>% 
janitor::clean_names() %>% 
rename(date = report_date, n_fatality = place_of_fatality) %>%
select(-deaths_by_county_of_residence) %>% 
mutate(date = lubridate::mdy(date))

ny_vax = read_csv("grace/ny_covidvax.csv") %>% 
janitor::clean_names() %>% 
rename(date = report_as_of) %>% 
select(-region, -series_complete) %>% 
mutate(date = lubridate::mdy(date))

ny_covid_v1 = left_join(ny_test, ny_death, by = c("date", "county"))

covid_df = left_join(ny_covid_v1, ny_vax, by = c("date", "county")) %>% 
  separate(date, c("year", "month", "day"), sep = "-") %>% 
  mutate(year = as.numeric(year), month = as.numeric(month), day = as.numeric(day))

covid_df_yr = covid_df %>% 
  group_by(county, year) %>% 
  summarise(new_cases = sum(new_positives),
            covid_tests = sum(total_number_of_tests_performed),
            vax_dose1 = max(first_dose))
```

## Merge Data for Analysis

Merge covid & hr/demo data by year

2020
```{r}
covid2020 = covid_df_yr %>% 
  filter(year == '2020') 

ny2020 = left_join(covid2020, merge2020, by = c("county", "year")) %>% 
  mutate(n_minority = n_black + n_hispanic)

ny2020_fin = left_join(ny2020, ny_df, by = "county")
```

2021
```{r}
covid2021 = covid_df_yr %>% 
  filter(year == '2021')
  
ny2021 = left_join(covid2021, merge2021, by = c("county", "year")) %>%
  mutate(n_minority = n_black + n_hispanic)

ny2021_fin = left_join(ny2021, ny_df, by = "county")
```

2022
```{r}
covid2022 = covid_df_yr %>% 
  filter(year == '2022')
  
ny2022 = left_join(covid2022, merge2022, by = c("county", "year"))

ny2022_fin = left_join(ny2022, ny_df, by = "county")
```

## Regression Test:
We are using data for 2021 since 2022 data is incomplete (only have data up to November)

### Model 1:
1. Outcome: # covid cases
2. Predictors: health ranking variables (ses_r, env_r, etc.), median age (medage)

```{r}
ny2021_fin %>% 
  lm(new_cases ~ longevity_r + qol_r + health_beh_r + clinical_care_r + ses_r + env_r + race_div + medage, data = .) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3)
# decided to remove race_div (makes all variable appear insignificant)

ny2021_fin %>% 
  lm(new_cases ~ longevity_r + qol_r + health_beh_r + clinical_care_r + ses_r + env_r + medage, data = .) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3) 
```

### Model 2:
1. Outcome: # individuals who got the first dose of vaccine
2. Predictors: health ranking variables (ses_r, env_r, etc.), racial diversity score (race_div), median age (med_age)

```{r}
ny2021_fin %>% 
  lm(vax_dose1 ~ longevity_r + qol_r + health_beh_r + clinical_care_r + ses_r + env_r + race_div + medage, data = .) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3) 
# decided to remove race_div (makes all variable appear insignificant)

ny2021_fin %>% 
  lm(vax_dose1 ~ longevity_r + qol_r + health_beh_r + clinical_care_r + ses_r + env_r + medage, data = .) %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 3) 
```

### Model 3:
1. Outcome: # covid cases
2. Predictors: median income, number of minorities, segregation score, and ses rank

```{r}
ny2021_fin

ny2021_fit =
  ny2021_fin %>% 
  lm(new_cases ~ median_income + n_minority + segregation_score + ses_r, data = .)

summary(ny2021_fit) # remove ses_r

ny2021_fit =
  ny2021_fin %>% 
  lm(new_cases ~ median_income + n_minority + segregation_score, data = .)

ny2021_fit %>% 
  broom::glance()

ny2021_fit %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 10)
```

### Model 4:
1. Outcome: # individuals who got the first dose of vaccine
2. Predictors: median income, number of minorities, segregation score, and ses rank

```{r}
ny2021_fit =
  ny2021_fin %>% 
  lm(vax_dose1 ~ median_income + n_minority + segregation_score + ses_r, data = .)

summary(ny2021_fit) # remove ses_r

ny2021_fit =
  ny2021_fin %>% 
  lm(vax_dose1 ~ median_income + n_minority + segregation_score, data = .)

ny2021_fit %>% 
  broom::glance()

ny2021_fit %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 10)
```